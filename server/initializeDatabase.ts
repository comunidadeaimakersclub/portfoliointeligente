import { db, pool } from './db';
import { sql } from 'drizzle-orm';
import { migrate } from 'drizzle-orm/postgres-js/migrator';
import { users, agents, agentPrompts } from '@shared/schema';
import { eq } from 'drizzle-orm';
import { hashPassword } from './auth';

/**
 * Verifica se a tabela especificada existe no banco de dados
 */
async function checkTableExists(tableName: string): Promise<boolean> {
  try {
    const result = await pool.query(`
      SELECT EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_schema = 'public'
        AND table_name = $1
      );
    `, [tableName]);
    
    return result.rows[0].exists;
  } catch (error) {
    console.error(`Erro ao verificar se a tabela ${tableName} existe:`, error);
    return false;
  }
}

/**
 * Cria as tabelas do schema manualmente se necess√°rio
 */
async function createTablesIfNotExist() {
  try {
    // Verifica se a tabela de usu√°rios existe
    const usersTableExists = await checkTableExists('users');
    
    if (!usersTableExists) {
      console.log('üîß Criando tabelas do banco de dados...');
      
      // Cria√ß√£o da tabela users
      await pool.query(`
        CREATE TABLE IF NOT EXISTS users (
          id SERIAL PRIMARY KEY,
          username TEXT NOT NULL UNIQUE,
          password TEXT NOT NULL,
          "isAdmin" BOOLEAN NOT NULL DEFAULT false,
          "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
        );
      `);
      
      // Cria√ß√£o da tabela agents
      await pool.query(`
        CREATE TABLE IF NOT EXISTS agents (
          id SERIAL PRIMARY KEY,
          title TEXT NOT NULL,
          description TEXT NOT NULL,
          icon TEXT NOT NULL,
          "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
        );
      `);
      
      // Cria√ß√£o da tabela agent_prompts
      await pool.query(`
        CREATE TABLE IF NOT EXISTS agent_prompts (
          id SERIAL PRIMARY KEY,
          "agentId" INTEGER NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
          prompt TEXT NOT NULL,
          "isActive" BOOLEAN NOT NULL DEFAULT false,
          "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
        );
      `);
      
      console.log('‚úÖ Tabelas criadas com sucesso!');
      return true;
    }
    
    return false;
  } catch (error) {
    console.error('‚ùå Erro ao criar tabelas:', error);
    throw error;
  }
}

/**
 * Cria dados iniciais se as tabelas estiverem vazias
 */
async function seedInitialData() {
  try {
    // Verifica se j√° existem usu√°rios
    const existingUsers = await db.select().from(users);
    
    if (existingUsers.length === 0) {
      console.log('üå± Populando banco de dados com dados iniciais...');
      
      // Cria usu√°rio admin
      const adminPassword = await hashPassword('admin');
      await db.insert(users).values({
        username: 'admin',
        password: adminPassword,
        isAdmin: true
      });
      
      // Lista de agentes
      const agentsList = [
        { title: 'Comercial', description: 'Assistente virtual para equipes comerciais e vendas', icon: 'fas fa-briefcase' },
        { title: 'Cl√≠nicas', description: 'Assistente especializado para cl√≠nicas e consult√≥rios m√©dicos', icon: 'fas fa-clinic-medical' },
        { title: 'Imobili√°rias', description: 'Assistente para corretores e profissionais do setor imobili√°rio', icon: 'fas fa-home' },
        { title: 'Jur√≠dico', description: 'Assistente virtual para escrit√≥rios de advocacia e profissionais da √°rea jur√≠dica', icon: 'fas fa-balance-scale' },
        { title: 'Financeiro', description: 'Assistente especializado em finan√ßas, contabilidade e planejamento financeiro', icon: 'fas fa-chart-line' },
        { title: 'Educa√ß√£o', description: 'Assistente virtual para institui√ß√µes de ensino e professores', icon: 'fas fa-graduation-cap' },
        { title: 'Restaurantes', description: 'Assistente para estabelecimentos gastron√¥micos e delivery', icon: 'fas fa-utensils' },
        { title: 'Eventos', description: 'Assistente especializado em organiza√ß√£o e promo√ß√£o de eventos', icon: 'fas fa-calendar-alt' },
        { title: 'Recursos Humanos', description: 'Assistente para recrutamento, sele√ß√£o e gest√£o de pessoas', icon: 'fas fa-users' },
        { title: 'Sa√∫de', description: 'Assistente virtual para profissionais da √°rea da sa√∫de', icon: 'fas fa-heartbeat' },
        { title: 'Varejo', description: 'Assistente especializado em lojas f√≠sicas e e-commerce', icon: 'fas fa-shopping-cart' },
        { title: 'Tecnologia', description: 'Assistente para empresas e profissionais de tecnologia', icon: 'fas fa-laptop-code' }
      ];
      
      // Insere os agentes
      for (const agent of agentsList) {
        await db.insert(agents).values(agent);
      }
      
      console.log('‚úÖ Dados iniciais criados com sucesso!');
    } else {
      console.log('‚ÑπÔ∏è Dados iniciais j√° existem no banco de dados.');
    }
  } catch (error) {
    console.error('‚ùå Erro ao criar dados iniciais:', error);
    throw error;
  }
}

/**
 * Inicializa o banco de dados
 */
export async function initializeDatabase() {
  try {
    console.log('üîç Verificando banco de dados...');
    
    // Verifica e cria tabelas se necess√°rio
    const tablesCreated = await createTablesIfNotExist();
    
    // Se as tabelas foram criadas ou j√° existiam, verifica os dados iniciais
    await seedInitialData();
    
    console.log('‚úÖ Banco de dados inicializado com sucesso!');
  } catch (error) {
    console.error('‚ùå Falha ao inicializar banco de dados:', error);
    throw error;
  }
}